{% extends "bases/base.html" %}
{% load static %} 

{% block content%}
<div class="messajesReserva">
    {% include 'bases/components/alertas.html' %}   
</div>

<div class="container-reserva">
<div class="messajesReserva-movil">
    {% include 'bases/components/alertas.html' %}   
</div>
    <h1>Reserva tu cancha</h1>
    <form id="reservaForm" method="post" action="{% url 'plantillas:reservar_hora' cancha.id_cancha %}">
        {% csrf_token %}
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" name="nombre" value="{{ cancha.nombre }}" readonly>
    
        <label for="fecha">Fecha:</label>
        <input type="date" id="fecha" name="fecha" readonly>
        {% include 'reservacion/calendario.html' %}
    
        <select id="hora_inicio" name="hora_inicio" required>
            <option value="">Selecciona una hora</option>
        </select>
        
        <select id="hora_fin" name="hora_fin" required>
            <option value="">Selecciona una hora</option>
        </select>
        
    
        <label for="cancha">Cancha:</label>
        <ul class="listaDeCanchas">
            {% for imagen in imagenes %}
                <li>
                    <img src="{{ imagen.imagen.url }}" alt="Imagen de la cancha deportiva">
                </li>
            {% endfor %}
        </ul>
    
        <button type="submit">Continuar</button>
    </form>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const monthYear = document.getElementById("month-year");
        const daysContainer = document.getElementById("days");
        const prevMonthBtn = document.getElementById("prev-month");
        const nextMonthBtn = document.getElementById("next-month");
        const calendar = document.getElementById("calendrio");
        const inputDate = document.getElementById("fecha");
    
        let diasDisponibles;
        let horasDisponibles;
        let reservas;
        try {
            diasDisponibles = JSON.parse('{{ dias_disponibles|escapejs }}');
            horasDisponibles = JSON.parse('{{ horas_disponibles|escapejs }}');
            reservas = JSON.parse('{{ reservas|escapejs }}');
        } catch (error) {
            console.error("Error parsing JSON data: ", error);
        }
    
        let currentDate = new Date();
        let calendarVisible = false;
    
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
            const lastDayOfLastMonth = new Date(year, month, 0).getDate();
    
            monthYear.innerText = date.toLocaleDateString("default", {
                month: "long",
                year: "numeric",
            });
    
            daysContainer.innerHTML = "";
    
            for (let i = firstDayOfMonth; i > 0; i--) {
                const day = document.createElement("div");
                day.classList.add("inactive");
                day.innerText = lastDayOfLastMonth - i + 1;
                daysContainer.appendChild(day);
            }
    
            for (let i = 1; i <= lastDateOfMonth; i++) {
                const day = document.createElement("div");
                day.innerText = i;
    
                const dayOfWeek = new Date(year, month, i).toLocaleDateString("default", { weekday: "long" }).toLowerCase();
                const dateString = new Date(year, month, i).toISOString().substring(0, 10);
                
                const availableHoursForDate = getAvailableHoursForDate(dateString);
                if (availableHoursForDate.length === 0 || !diasDisponibles.includes(dayOfWeek)) {
                    day.classList.add("inactive");
                }

                const hasAvailableHours = reservas.filter(r => r.fecha === dateString).length < horasDisponibles.length - 1;
                if (!hasAvailableHours || !diasDisponibles.includes(dayOfWeek)) {
                    day.classList.add("inactive");
                }
                
                if (
                    i === currentDate.getDate() &&
                    year === currentDate.getFullYear() &&
                    month === currentDate.getMonth()
                ) {
                    day.classList.add("today");
                }
    
                if (hasAvailableHours && diasDisponibles.includes(dayOfWeek)) {
                    day.addEventListener("click", () => {
                        const selectedDate = new Date(year, month, i);
                        inputDate.value = selectedDate.toISOString().substring(0, 10);
                        calendar.style.display = "none";
                        calendarVisible = false;
                        updateHoraOptions(selectedDate.toISOString().substring(0, 10));
                    });
                }
    
                daysContainer.appendChild(day);
            }
        }
        function getAvailableHoursForDate(dateString) {
            let availableHours = [...horasDisponibles];
            for (let reserva of reservas) {
                if (reserva.fecha === dateString) {
                    const horaInicioReserva = new Date(`1970-01-01T${reserva.horainicio}:00`);
                    const horaFinReserva = new Date(`1970-01-01T${reserva.horafin}:00`);
                    availableHours = availableHours.filter(hora => {
                        const optionHora = new Date(`1970-01-01T${hora}:00`);
                        return optionHora < horaInicioReserva || optionHora > horaFinReserva;
                    });
                }
            }
            return availableHours;
        }
        function updateHoraOptions(fecha) {
            const horaInicioSelect = document.getElementById("hora_inicio");
            const horaFinSelect = document.getElementById("hora_fin");
    
            horaInicioSelect.innerHTML = '<option value="">Selecciona una hora</option>';
            horaFinSelect.innerHTML = '<option value="">Selecciona una hora</option>';
    
            let availableHours = getAvailableHoursForDate(fecha);
            for (let reserva of reservas) {
                if (reserva.fecha === fecha) {
                    const horaInicioReserva = new Date(`1970-01-01T${reserva.horainicio}:00`);
                    const horaFinReserva = new Date(`1970-01-01T${reserva.horafin}:00`);
                    availableHours = availableHours.filter(hora => {
                        const optionHora = new Date(`1970-01-01T${hora}:00`);
                        return optionHora < horaInicioReserva || optionHora > horaFinReserva;
                    });
                }
            }
    
            for (let hora of availableHours) {
                horaInicioSelect.innerHTML += `<option value="${hora}">${hora}</option>`;
                horaFinSelect.innerHTML += `<option value="${hora}">${hora}</option>`;
            }
    
            horaInicioSelect.addEventListener("change", function () {
                const selectedHoraInicio = this.value;
                const selectedHoraInicioDate = new Date(`1970-01-01T${selectedHoraInicio}:00`);
    
                Array.from(horaFinSelect.options).forEach(option => {
                    const optionHora = new Date(`1970-01-01T${option.value}:00`);
                    if (optionHora <= selectedHoraInicioDate) {
                        option.disabled = true;
                    } else {
                        option.disabled = false;
                    }
                });
            });
        }
    
        renderCalendar(currentDate);
    
        prevMonthBtn.addEventListener("click", function () {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });
    
        nextMonthBtn.addEventListener("click", function () {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });
    
        inputDate.addEventListener("focus", function () {
            if (calendarVisible) {
                calendar.style.display = "none";
                calendarVisible = false;
            } else {
                calendar.style.display = "block";
                calendarVisible = true;
            }
        });
    });
          
</script>


{% endblock %}
   