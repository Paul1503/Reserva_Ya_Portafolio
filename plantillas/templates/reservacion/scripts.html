<script>
    document.addEventListener("DOMContentLoaded", function () {
        const monthYear = document.getElementById("month-year");
        const daysContainer = document.getElementById("days");
        const prevMonthBtn = document.getElementById("prev-month");
        const nextMonthBtn = document.getElementById("next-month");
        const calendar = document.getElementById("calendar");
        const inputDate = document.getElementById("fecha");
    
        const diasDisponibles = JSON.parse('{{ dias_disponibles|escapejs }}');
        const horasDisponibles = JSON.parse('{{ horas_disponibles|escapejs }}');
        const reservas = JSON.parse('{{ reservas|escapejs }}');
    
        let currentDate = new Date();
        let calendarVisible = false;
    
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
            const lastDayOfLastMonth = new Date(year, month, 0).getDate();
    
            monthYear.innerText = date.toLocaleDateString("default", {
                month: "long",
                year: "numeric",
            });
    
            daysContainer.innerHTML = "";
    
            for (let i = firstDayOfMonth; i > 0; i--) {
                const day = document.createElement("div");
                day.classList.add("inactive");
                day.innerText = lastDayOfLastMonth - i + 1;
                daysContainer.appendChild(day);
            }
    
            for (let i = 1; i <= lastDateOfMonth; i++) {
                const day = document.createElement("div");
                day.innerText = i;
    
                const dayOfWeek = new Date(year, month, i).toLocaleDateString("default", { weekday: "long" }).toLowerCase();
                if (!diasDisponibles.includes(dayOfWeek)) {
                    day.classList.add("inactive");
                }
    
                if (
                    i === currentDate.getDate() &&
                    year === currentDate.getFullYear() &&
                    month === currentDate.getMonth()
                ) {
                    day.classList.add("today");
                }
    
                if (diasDisponibles.includes(dayOfWeek)) {
                    day.addEventListener("click", () => {
                        const selectedDate = new Date(year, month, i);
                        inputDate.value = selectedDate.toISOString().substring(0, 10);
                        calendar.style.display = "none";
                        calendarVisible = false;
                        updateHoraOptions(selectedDate.toISOString().substring(0, 10));
                    });
                }
    
                daysContainer.appendChild(day);
            }
        }
    
        function updateHoraOptions(fecha) {
            const horaInicioSelect = document.getElementById("hora_inicio");
            const horaFinSelect = document.getElementById("hora_fin");
    
            horaInicioSelect.innerHTML = '<option value="">Selecciona una hora</option>';
            horaFinSelect.innerHTML = '<option value="">Selecciona una hora</option>';
    
            for (let hora of horasDisponibles) {
                horaInicioSelect.innerHTML += `<option value="${hora}">${hora}</option>`;
                horaFinSelect.innerHTML += `<option value="${hora}">${hora}</option>`;
            }
    
            for (let reserva of reservas) {
                if (reserva.fecha === fecha) {
                    const horaInicioReserva = new Date(`1970-01-01T${reserva.horainicio}:00`);
                    const horaFinReserva = new Date(`1970-01-01T${reserva.horafin}:00`);
                    Array.from(horaInicioSelect.options).forEach(option => {
                        const optionHora = new Date(`1970-01-01T${option.value}:00`);
                        if (optionHora >= horaInicioReserva && optionHora < horaFinReserva) {
                            option.disabled = true;
                        }
                    });
                    Array.from(horaFinSelect.options).forEach(option => {
                        const optionHora = new Date(`1970-01-01T${option.value}:00`);
                        if (optionHora > horaInicioReserva && optionHora <= horaFinReserva) {
                            option.disabled = true;
                        }
                    });
                }
            }
    
            horaInicioSelect.addEventListener("change", function () {
                const selectedHoraInicio = this.value;
                const selectedHoraInicioDate = new Date(`1970-01-01T${selectedHoraInicio}:00`);
    
                Array.from(horaInicioSelect.options).forEach(option => {
                    const optionHora = new Date(`1970-01-01T${option.value}:00`);
                    if (optionHora < selectedHoraInicioDate) {
                        option.disabled = true;
                    }
                });
    
                Array.from(horaFinSelect.options).forEach(option => {
                    const optionHora = new Date(`1970-01-01T${option.value}:00`);
                    if (optionHora <= selectedHoraInicioDate) {
                        option.disabled = true;
                    }
                });
            });
        }
    
        renderCalendar(currentDate);
    
        prevMonthBtn.addEventListener("click", function () {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });
    
        nextMonthBtn.addEventListener("click", function () {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });
    
        inputDate.addEventListener("focus", function () {
            if (calendarVisible) {
                calendar.style.display = "none";
                calendarVisible = false;
            } else {
                calendar.style.display = "block";
                calendarVisible = true;
            }
        });
    });      
</script>